services:
  electrumx:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: electrumx_server
    restart: unless-stopped
    ports:
      - "50010:50010"   # Port for TCP connections
      - "50011:50011"   # Port for WSS connections (Photonic wallet)
      - "50012:50012"   # Port for SSL connections
      - "8000:8000"     # Port for REST API
      - "127.0.0.1:8001:8001"  # Admin RPC (localhost only)
    # NOTE: SYS_PTRACE removed for production security
    # For debugging, uncomment the following:
    # cap_add:
    #   - SYS_PTRACE
    networks:
      - default
      - radiant-net
    environment:
      - ALLOW_ROOT=1
      - DAEMON_URL=http://radiant_user:RxS3cur3P@ssw0rd!2025@radiant-node-mainnet:7332
      - COIN=${COIN}
      - NET=${NET}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT}
      - DB_DIRECTORY=${DB_DIRECTORY}
      - DB_ENGINE=${DB_ENGINE}
      - SERVICES=${SERVICES}
      - SSL_CERTFILE=${SSL_CERTFILE}
      - SSL_KEYFILE=${SSL_KEYFILE}
      - REST_API_ENABLED=${REST_API_ENABLED:-1}
      - REST_API_HOST=${REST_API_HOST:-0.0.0.0}
      - REST_API_PORT=${REST_API_PORT:-8000}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - REST_API_KEY=${REST_API_KEY}
      - CACHE_MB=${CACHE_MB}
      - MAX_SESSIONS=${MAX_SESSIONS}
      - MAX_SEND=${MAX_SEND}
      - MAX_RECV=${MAX_RECV}
    user: "0:0"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50010 || exit 1"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 300s
    stop_signal: SIGTERM
    stop_grace_period: 180s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    deploy:
      resources:
        reservations:
          memory: 4G
    volumes:
      - ./electrumdb:/data/electrumdb   # Mount local directory for database and SSL keys
    entrypoint: ["python3", "electrumx_server"]

networks:
  radiant-net:
    external: true
    name: radiant-stratum-proxy-main_radiant-net
