services:
  electrumx:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: electrumx_server
    restart: unless-stopped
    ports:
      - "50010:50010"   # Port for TCP connections
      - "50011:50011"   # Port for WSS connections (Photonic wallet)
      - "50012:50012"   # Port for SSL connections
      - "8000:8000"     # Port for REST API
      - "127.0.0.1:8001:8001"  # Admin RPC (localhost only)
    # NOTE: SYS_PTRACE removed for production security
    # For debugging, uncomment the following:
    # cap_add:
    #   - SYS_PTRACE
    environment:
      - DAEMON_URL=${DAEMON_URL}
      - COIN=${COIN}
      - NET=${NET}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT}
      - DB_DIRECTORY=${DB_DIRECTORY}
      - DB_ENGINE=${DB_ENGINE}
      - SERVICES=${SERVICES}
      - SSL_CERTFILE=${SSL_CERTFILE}
      - SSL_KEYFILE=${SSL_KEYFILE}
      - REST_API_ENABLED=${REST_API_ENABLED:-1}
      - REST_API_HOST=${REST_API_HOST:-0.0.0.0}
      - REST_API_PORT=${REST_API_PORT:-8000}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - REST_API_KEY=${REST_API_KEY}
      - CACHE_MB=${CACHE_MB:-2000}
      - MAX_SESSIONS=${MAX_SESSIONS:-10000}
      - MAX_SEND=${MAX_SEND:-10000000}
      - MAX_RECV=${MAX_RECV:-10000000}
      # Rate limiting (relaxed to prevent local RPC throttling disconnects)
      - COST_SOFT_LIMIT=${COST_SOFT_LIMIT:-10000}
      - COST_HARD_LIMIT=${COST_HARD_LIMIT:-100000}
      - INITIAL_CONCURRENT=${INITIAL_CONCURRENT:-50}
      - REQUEST_SLEEP=${REQUEST_SLEEP:-500}
      # RXinDexer: Glyph token indexing (FT, NFT, dMint, Mutable, Containers)
      - GLYPH_INDEX=${GLYPH_INDEX:-1}
      # RXinDexer: WAVE naming system indexing
      - WAVE_INDEX=${WAVE_INDEX:-1}
      - WAVE_HOT_NAMES=${WAVE_HOT_NAMES:-10000}
      # RXinDexer: Swap DEX order indexing
      - SWAP_INDEX=${SWAP_INDEX:-1}
      # RXinDexer: Real-time WebSocket subscriptions
      - GLYPH_SUBSCRIPTIONS=${GLYPH_SUBSCRIPTIONS:-1}
      # RXinDexer: Mempool indexing for unconfirmed transactions
      - MEMPOOL_GLYPH_INDEX=${MEMPOOL_GLYPH_INDEX:-1}
      - MEMPOOL_SWAP_INDEX=${MEMPOOL_SWAP_INDEX:-1}
      # RXinDexer: dMint contracts file
      - DMINT_CONTRACTS_FILE=${DMINT_CONTRACTS_FILE:-/data/electrumdb/contracts.json}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    user: "1000:1000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50010 || exit 1"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 300s
    stop_signal: SIGTERM
    stop_grace_period: 180s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    deploy:
      resources:
        reservations:
          memory: 4G
    volumes:
      - ./electrumdb:/data/electrumdb   # Mount local directory for database and SSL keys
