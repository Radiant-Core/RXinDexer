# RXinDexer Test Dockerfile
# Builds from local source for integration testing

FROM ubuntu:22.04

LABEL maintainer="RXinDexer Test"
LABEL description="RXinDexer integration test image"

ARG DEBIAN_FRONTEND=noninteractive
ENV PACKAGES="\
  build-essential \
  pkg-config \
  git \
  netcat-openbsd \
  python3 \
  python3-pip \
  python3-dev \
  libleveldb-dev \
  libsnappy-dev \
"

RUN apt update && apt install --no-install-recommends -y $PACKAGES && \
    rm -rf /var/lib/apt/lists/* && \
    apt clean

RUN groupadd -r electrumx && useradd -r -g electrumx -u 1000 electrumx

# Create directory for DB
RUN mkdir -p /data/electrumdb && chown -R electrumx:electrumx /data
<<<<<<< /Users/main/Documents/Radiant/RXinDexer/Dockerfile.test
<<<<<<< /Users/main/Documents/Radiant/RXinDexer/Dockerfile.test
<<<<<<< /Users/main/Documents/Radiant/RXinDexer/Dockerfile.test
=======

RUN mkdir -p /home/electrumx/electrumx && chown -R electrumx:electrumx /home/electrumx
>>>>>>> /Users/main/.windsurf/worktrees/RXinDexer/RXinDexer-c38ad641/Dockerfile.test
=======

RUN mkdir -p /home/electrumx/electrumx && chown -R electrumx:electrumx /home/electrumx
>>>>>>> /Users/main/.windsurf/worktrees/RXinDexer/RXinDexer-c38ad641/Dockerfile.test
=======

RUN mkdir -p /home/electrumx/electrumx && chown -R electrumx:electrumx /home/electrumx
>>>>>>> /Users/main/.windsurf/worktrees/RXinDexer/RXinDexer-c38ad641/Dockerfile.test

WORKDIR /home/electrumx/electrumx

# Copy local source
COPY . .

RUN chown -R electrumx:electrumx /home/electrumx/electrumx

# Install Python dependencies
RUN python3 -m pip install --upgrade pip
RUN python3 -m pip install \
    'aiorpcx>=0.22,<0.23' \
    attrs \
    plyvel \
    aiohttp \
    cbor2 \
    websockets \
    pylru \
    pytest

# Default environment
ENV COIN=Radiant
ENV NET=mainnet
ENV DB_ENGINE=leveldb
ENV DB_DIRECTORY=/data/electrumdb
ENV LOG_LEVEL=INFO

# RXinDexer features enabled by default
ENV GLYPH_INDEX=1
ENV WAVE_INDEX=1
ENV SWAP_INDEX=1
ENV GLYPH_SUBSCRIPTIONS=1
ENV MEMPOOL_GLYPH_INDEX=1
ENV MEMPOOL_SWAP_INDEX=1

EXPOSE 50010 8001

USER electrumx

ENTRYPOINT ["python3", "electrumx_server"]
